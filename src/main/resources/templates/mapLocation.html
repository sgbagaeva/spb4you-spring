<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üó∫Ô∏è</text></svg>">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Map</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css" />
  <link rel="stylesheet" th:href="@{/styles/map.css}" />
  <style>
    /* –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å—Ç–∏–ª—è –¥–ª—è –≤—Å–ø–ª—ã–≤–∞—é—â–µ–≥–æ –æ–∫–Ω–∞ */
    .leaflet-popup {
      width: 370px;  /* –®–∏—Ä–∏–Ω–∞ */
      max-width: 400px;  /* –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —à–∏—Ä–∏–Ω–∞ */
    }
  </style>
</head>
<body>
  <div id="map"></div>
<!--  <script type="module" th:src="@{/scripts/map.js}"></script>-->
  <script th:inline="javascript">
    const locationId = /*[[${locationId}]]*/ 1; // –í—ã—Å—Ç–∞–≤–ª—è–µ–º –∏–∑ Thymeleaf
    const locationCoordinates = /*[[${locationCoordinates}]]*/ [59.962417, 30.312833]; // –¢–æ–∂–µ –∏–∑ Thymeleaf, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    const imageSrc = "/elements/loc" + locationId + "/forMap.png";
  </script>
  <script type="module">
    import "https://unpkg.com/leaflet@1.9.4/dist/leaflet.js";
    import "https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js";
    import "https://unpkg.com/@maplibre/maplibre-gl-leaflet@0.0.22/leaflet-maplibre-gl.js";

    const middleOfSPB = [59.9343, 30.3351]; // –†–µ–∑–µ—Ä–≤–Ω—ã–π —Ü–µ–Ω—Ç—Ä

    async function getLocation() {
        try {
            const response = await fetch("http://ip-api.com/json/");
            const json = await response.json();
            if (typeof json.lat === "number" && typeof json.lon === "number") {
                return [json.lat, json.lon];
            }
        } catch (error) {}
        return middleOfSPB; // –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ü–µ–Ω—Ç—Ä –°–ü–ë, –µ—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
    }

    async function init() {
        const map = L.map('map').setView(locationCoordinates, 18); // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–∏–¥ –Ω–∞ –ª–æ–∫–∞—Ü–∏—é –∏ –∑–∞–¥–∞–µ–º –º–∞—Å—à—Ç–∞–±

        L.maplibreGL({
            style: 'https://tiles.openfreemap.org/styles/liberty',
            attribution: `<a href="https://openfreemap.org" target="_blank">OpenFreeMap</a> <a href="https://www.openmaptiles.org/" target="_blank">¬© OpenMapTiles</a> Data from <a href="https://www.openstreetmap.org/copyright" target="_blank">OpenStreetMap</a>`,
        }).addTo(map);

        const houseMarker = L.marker(locationCoordinates).addTo(map)
            .bindPopup(`
                <img src="${imageSrc}" title="–§–æ—Ç–æ —Å –ª–æ–∫–∞—Ü–∏–∏ —Å ID: ${locationId}" style="max-width: 110%; height: auto;">
            `) // –ú–µ–Ω—è–µ–º –Ω–∞ –∞–¥—Ä–µ—Å, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–ª—É—á–∞–µ—Ç id –Ω–∞ –æ—Å–Ω–æ–≤–µ Thymeleaf
            .openPopup(); // –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –≤—Å–ø–ª—ã–≤–∞—é—â–µ–µ –æ–∫–Ω–æ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∫–∞—Ä—Ç—ã

        // –≠—Ñ—Ñ–µ–∫—Ç –≤—ã–¥–µ–ª–µ–Ω–∏—è –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏
        houseMarker.on('mouseover', function (e) {
            this.openPopup(); // –û—Ç–∫—Ä—ã–≤–∞–µ—Ç –≤—Å–ø–ª—ã–≤–∞—é—â–µ–µ –æ–∫–Ω–æ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏
            this.setOpacity(0.7); // –£–º–µ–Ω—å—à–∞–µ—Ç –Ω–µ–ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –º–µ—Ç–∫–∏
        });

        houseMarker.on('mouseout', function (e) {
            this.closePopup(); // –ó–∞–∫—Ä—ã–≤–∞–µ—Ç –≤—Å–ø–ª—ã–≤–∞—é—â–µ–µ –æ–∫–Ω–æ –ø—Ä–∏ —É—Ö–æ–¥–µ –º—ã—à–∏
            this.setOpacity(1); // –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–µ–ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –∫ –Ω–æ—Ä–º–µ
        });
    }

    init();
  </script>
</body>
</html>

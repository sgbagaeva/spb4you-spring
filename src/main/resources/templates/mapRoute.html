<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üó∫Ô∏è</text></svg>">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ö–∞—Ä—Ç–∞</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
  <link rel="stylesheet" th:href="@{/styles/map.css}" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Unbounded:wght@200..900&display=swap" rel="stylesheet">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <style>
    /* –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å—Ç–∏–ª—è –¥–ª—è –≤—Å–ø–ª—ã–≤–∞—é—â–µ–≥–æ –æ–∫–Ω–∞ */
    .leaflet-popup {
        max-width: none; /* –£–±–∏—Ä–∞–µ–º –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —à–∏—Ä–∏–Ω—ã */
        padding: 5px; /* –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ—Ç—Å—Ç—É–ø—ã –≤–Ω—É—Ç—Ä–∏ */
        font-family: Unbounded, sans-serif; /* –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —à—Ä–∏—Ñ—Ç–∞ */
    }
  </style>
</head>
<body>
<div id="map" style="height: 100vh;"></div>

<script th:inline="javascript">
  const routeId = /*[[${routeId}]]*/ 1; // –ü—Ä–∏–º–µ—Ä Thymeleaf
  const pointsMap = /*[[${points}]]*/ {
      '–õ–æ–∫–∞—Ü–∏—è 1': [59.962417, 30.312833],
      '–õ–æ–∫–∞—Ü–∏—è 2': [59.9343, 30.3351],
      '–ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å': [59.9311, 30.3175],
      'no –õ–æ–∫–∞—Ü–∏—è 3': [59.9211, 30.2990],  // –ù–∞–ø—Ä–∏–º–µ—Ä, —Ç–æ—á–∫–∞ –¥–ª—è –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏—è
  }; // –ü—Ä–∏–º–µ—Ä —Å—Ç—Ä—É–∫—Ç—É—Ä—ã Map
</script>

<script type="module">
  import "https://unpkg.com/leaflet@1.9.4/dist/leaflet.js";
  import "https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js";
  import "https://unpkg.com/@maplibre/maplibre-gl-leaflet@0.0.22/leaflet-maplibre-gl.js";
  import "https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js";

  const middleOfSPB = [59.9343, 30.3351]; // –¶–µ–Ω—Ç—Ä –°–ü–ë –¥–ª—è —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç

  async function init() {
      const map = L.map('map').setView(middleOfSPB, 13); // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–∏–¥ –Ω–∞ —Ü–µ–Ω—Ç—Ä –°–ü–ë

      // –î–æ–±–∞–≤–ª—è–µ–º –∫–∞—Ä—Ç—É
      L.maplibreGL({
          style: 'https://tiles.openfreemap.org/styles/liberty',
          attribution: `<a href="https://openfreemap.org" target="_blank">OpenFreeMap</a> <a href="https://www.openmaptiles.org/" target="_blank">¬© OpenMapTiles</a> Data from <a href="https://www.openstreetmap.org/copyright" target="_blank">OpenStreetMap</a>`,
      }).addTo(map);

      // –ú–∞—Å—Å–∏–≤ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
      const latLngArray = [];
      for (const [name, coords] of Object.entries(pointsMap)) {
          // –í–∫–ª—é—á–∞–µ–º –≤—Å–µ —Ç–æ—á–∫–∏ –≤ –º–∞—Ä—à—Ä—É—Ç, –¥–∞–∂–µ –µ—Å–ª–∏ name —Å–æ–¥–µ—Ä–∂–∏—Ç "no"
          latLngArray.push(L.latLng(coords[0], coords[1])); // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –¥–ª—è –º–∞—Ä—à—Ä—É—Ç–∞

          if (!name.includes("no")) { // –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ name –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç "no"
              const marker = L.marker(coords).addTo(map)
                  .bindPopup(name); // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏–º—è —Ç–æ—á–∫–∏

              // –≠—Ñ—Ñ–µ–∫—Ç—ã –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –Ω–∞ –º–∞—Ä–∫–µ—Ä
              marker.on('mouseover', function () {
                  this.openPopup();
                  this.setOpacity(0.7); // –£–º–µ–Ω—å—à–∞–µ–º –Ω–µ–ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏
              });
              marker.on('mouseout', function () {
                  this.closePopup();
                  this.setOpacity(1); // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–µ–ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å
              });
          }
      }

      // –ü—Ä–æ–∫–ª–∞–¥—ã–≤–∞–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞ —á–µ—Ä–µ–∑ –∑–∞–¥–∞–Ω–Ω—ã–µ —Ç–æ—á–∫–∏
      const polyline = L.polyline(latLngArray, {
          color: '#9370d8', // –ù–µ–∂–Ω–æ-—Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π —Ü–≤–µ—Ç
          weight: 5,
          dashArray: '10, 15' // –î–ª–∏–Ω–∞ –∏ –ø—Ä–æ–º–µ–∂—É—Ç–æ–∫ –¥–ª—è –ø—É–Ω–∫—Ç–∏—Ä–Ω–æ–π –ª–∏–Ω–∏–∏
      }).addTo(map);

      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–∏–¥ –∫–∞—Ä—Ç—ã, —á—Ç–æ–±—ã –≤–∫–ª—é—á–∏—Ç—å –≤—Å—é –ª–∏–Ω–∏—é –º–∞—Ä—à—Ä—É—Ç–∞
      map.fitBounds(polyline.getBounds());
  }

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É
  init();
</script>
</body>
</html>
